<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer-fontawesome/polymer-fontawesome.html">
<link rel="import" href="../bower_components/sortable-table/sortable-table.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-header.html">
<link rel="import" href="../lib/jsorolla/src/network-viewer/jso-network-viewer.html">
<link rel="import" href="potyvirus-home.html">

<link rel="import" href="components/pty-toolbar.html">
<link rel="import" href="components/pty-header.html">
<link rel="import" href="components/pty-3d-toolbar.html">
<link rel="import" href="components/potyvirus-interactions-table.html">

<script src="../lib/jsorolla/src/network-viewer-webgl/network-viewer-webgl.js"></script>

<polymer-element name="potyvirus-element">
    <template>
        <link rel="stylesheet" href="../lib/jsorolla/src/lib/components/jso-style.css">
        <style>
            :host {
                display: block;
                position: relative;
                background-color: #314559;

                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                cursor: default;

                font-size: 13px;
            }

            [hide=true] {
                display: none !important;
            }

            /*potyvirus-interactions-table {*/
            /*height: calc(100vh - 60px);*/
            /*}*/
            jso-network-viewer {
                height: calc(100vh - 90px);
            }

            #stats {
                background-color: #FFFFFF;
                text-align: center;
                border-top: 1px solid #d3d3d3;
                padding-top: 20px;
            }

            .infoshown {
                visibility: visible !important;
                opacity: 1 !important;
            }

            #info {
                position: fixed;
                top: 100px;
                left: 30px;
                padding: 10px;
                background-color: #fff;
                box-shadow: 10px 10px 10px rgba(0, 0, 0, 0.2);
                /*transition: all 0.15s;*/
                visibility: hidden;
                opacity: 0;
                color: #666;
            }

            #menu3d {
                position: fixed;
                top: 60px;
                left: 0px;
            }

        </style>
        <jso-header selectedOption="{{selectedOption}}" userData="{{userData}}" allowLogin="false"
                    options="{{options}}">
            <div class="title">Potyvirus</div>
        </jso-header>

        <potyvirus-home hidden?="{{selectedOption != 'home' }}"></potyvirus-home>

        <template if="{{selectedOption == 'stats' }}">
            <div id="stats">
                <pty-heatmap></pty-heatmap>
                <pty-simpson-index></pty-simpson-index>
                <pty-4a></pty-4a>
                <pty-4b></pty-4b>
                <pty-4c></pty-4c>
                <pty-4d></pty-4d>
                <pty-4e></pty-4e>
                <pty-4f></pty-4f>
            </div>
        </template>

        <potyvirus-interactions-table data="{{data}}" hidden?="{{selectedOption != 'interactions'}}"></potyvirus-interactions-table>
        <jso-network-viewer id="networkViewer" hidden?="{{selectedOption != 'vhpi'}}"></jso-network-viewer>

        <div horizontal layout id="menu3d" hidden?="{{selectedOption != 'vhpi3d'}}">
            <div class="button action" on-click="{{handle3dLayout}}" data-v="force">Force layout</div>
            <div class="button action" on-click="{{handle3dLayout}}" data-v="circle">Circle</div>
        </div>
        <div id="nvwebgl" hidden?="{{selectedOption != 'vhpi3d'}}">
        </div>

        <div id="info" hidden?="{{selectedOption != 'vhpi3d'}}">{{message}}</div>
    </template>
    <script>
        Polymer({
            created: function () {
                this.options = this.getOptions();
                this.data = [];
                this.userData;
                this.potyvirusPorteinNames = {
                    'P1': true,
                    'HC-Pro': true,
                    'P3': true,
                    '6K1': true,
                    'CI': true,
                    '6K2': true,
                    'VPg': true,
                    'NIa-Pro': true,
                    'NIb': true,
                    'CP': true,
                    'P3N-PIPO': true
                };

                this.message = "";
            },
            selectedOptionChanged: function () {
                var me = this;
                setTimeout(function () {
//                    me.$.networkViewer.zoom = 20;
                    me.$.networkViewer.setLayout('Circle');
                }, 300);
            },
            handle3dLayout: function (e) {
                this.showInfo("Loading...");
                this.testPlantInteractome(e.currentTarget.dataset.v);
            },
            showInfo: function (msg) {
                if (msg == false) {
                    this.message = "";
                    this.$.info.classList.remove('infoshown');
                } else {
                    this.message = msg;
                    this.$.info.classList.add('infoshown');
                }
            },
            ready: function () {
                this.selectedOption = 'vhpi3d';
                this.$.networkViewer.selectedMenu = '';
                this.$.networkViewer.hideNodeSimpleRendering = true;
                this.$.networkViewer.hideEdgeSimpleRendering = true;
            },
            domReady: function () {
                this.getData();
                this.getInteractionsSif();

                var height = window.innerHeight - 65;
                var width = window.innerWidth;
                this.networkViewerWebgl = new NetworkViewerWebgl({
                    target: this.$.nvwebgl,
                    width: width,
                    height: height
                });

                var me = this;
                setTimeout(function () {
//                    me.getPlantInteractome();
                    me.testPlantInteractome("force");
                }, 100);


            },
            handleAppMenu: function (e) {
                this.$.sidePanel.classList.toggle('side-panel-shown');
            },
            getOptions: function () {
                return [
                    {
                        option: 'interactions',
                        text: 'Interactions'
                    },
                    {
                        option: 'vhpi',
                        text: 'VHPI'
                    },
                    {
                        option: 'vhpi3d',
                        text: 'VHPI3D'
                    },
                    {
                        option: 'stats',
                        text: 'Stats'
                    }
                ]
            },
            getData: function () {
                var me = this;
                var request = new XMLHttpRequest();
                request.onload = function () {
                    var lines = this.response.split('\n');
                    var data = [];
                    for (var i = 0; i < lines.length; i++) {
                        var fields = lines[i].split('\t');
                        var obj = {
                            id: fields[0],
                            p1: fields[1],
                            p2: fields[2],
                            reference: fields[3],
                            specie: fields[4],
                            cellularLocation: fields[5],
                            'function': fields[6],
                            detection: fields[7],
                            intensity: fields[8]
                        };
                        data.push(obj);
                    }
                    me.data = data;
                };
                request.onerror = function () {
                    console.log('error loading file');
                };
                request.open('GET', 'files/potyvirus-interactions-data-1.1.txt', true);
                request.send();
            },
            getInteractionsSif: function () {
                var me = this;
                var request = new XMLHttpRequest();
                request.onload = function () {

                    var adapter = new SIFNetworkDataAdapter({
                        dataSource: new StringDataSource(this.response),
                        handlers: {
                            'data:load': function (event) {
                                me.$.networkViewer.setGraph(event.graph);
                                me.getInteractionsAttr();
                            },
                            'error:parse': function (event) {
                                me.message = event.errorMsg;
                            }
                        }
                    });

                };
                request.onerror = function () {
                    console.log('error loading file');
                };
                request.open('GET', 'files/interactions-1.3.sif', true);
                request.send();
            },
            getInteractionsAttr: function () {

                var me = this;
                var request = new XMLHttpRequest();
                request.onload = function () {

                    new AttributeNetworkDataAdapter({
                        dataSource: new StringDataSource(this.response),
                        handlers: {
                            'data:load': function (event) {
                                me.$.networkViewer.importEdgeAttributeManager(event.attributeManager);
                                var row, matches = {};
                                for (var i = 0; i < me.$.networkViewer.eAttr.data.length; i++) {
                                    row = me.$.networkViewer.eAttr.data[i];
                                    matches[row["Weight"]] = row["Weight"];
                                }
                                me.$.networkViewer.edgeVisualSets.opacity = {
                                    attribute: "Weight",
                                    renderProperty: 'opacity',
                                    matches: matches,
                                    enabled: true,
                                    parse: 'string'
                                };
                                me.$.networkViewer.handleEdgeDefaultOpacity();
                            },
                            'error:parse': function (event) {
                                me.message = event.errorMsg;
                            }
                        }
                    });

                };
                request.onerror = function () {
                    console.log('error loading file');
                };
                request.open('GET', 'files/interactions-1.3-weighted.attr', true);
                request.send();
            },
            getPlantInteractome: function () {
                var me = this;
                var request = new XMLHttpRequest();
                request.onload = function () {
                    var textNetworkDataAdapter = new TextNetworkDataAdapter({
                        dataSource: new StringDataSource(this.response),
                        handlers: {
                            'data:load': function (event) {
//                        var graph = event.sender.parseColumns(0, 1, -1, 'hh');
                                var graph = event.sender.parseColumns(0, 2, 1);
//                        sphereSurface(graph.vertices, 400, 300);
//                        circleLevels(graph.vertices, 600, 300);


//                        var virusVertices = [];
//                        var plantVertices = [];
//
//                        for (var i = 0, l = graph.vertices.length; i < l; i++) {
//                            var vertex = graph.vertices[i];
//                            if (typeof vertex !== 'undefined') {
//                                if (vertex.id in potyvirusPorteinNames) {
//                                    virusVertices.push(vertex);
//                                } else {
//                                    plantVertices.push(vertex);
//                                }
//                            }
//                        }
//                            circleLevels(virusVertices, 300, 50);
//                            circleLevels(plantVertices, 500, 350);
//                            networkViewerWebgl.renderGraph(graph);

                                me.forceDirected(graph.vertices, graph.edges, function (vertices) {
                                    for (var i = 0; i < vertices.length; i++) {
                                        var v = vertices[i];
                                        var vertex = graph.getVertexById(v.id);
                                        var z = 0;
                                        if (vertex.id in me.potyvirusPorteinNames) {
                                            z = 100;
                                        } else {
                                            z = 300;
                                        }
                                        vertex.position.set(v.x, v.y, z);
                                    }
                                    me.networkViewerWebgl.renderGraph(graph);
                                });

                            },
                            'error:parse': function (event) {
                                console.log(event);
                            }
                        }
                    });

                };
                request.onerror = function () {
                    console.log('error loading file');
                };
                request.open('GET', 'files/vh0-1.sif', true);
                request.send();
            },
            testPlantInteractome: function (layout) {
                this.showInfo("Loading...");
                var start = new Date().getTime();

                var me = this;
                var request = new XMLHttpRequest();
                request.onload = function () {
                    var textNetworkDataAdapter = new TextNetworkDataAdapter({
                        dataSource: new StringDataSource(this.response),
                        handlers: {
                            'data:load': function (event) {
                                var graph = event.sender.parseColumns(0, 1, -1, 'i');
                                var visited = {};
                                var processNode = function (node, lvl) {
                                    if (!visited[node.id]) {
                                        visited[node.id] = lvl;
                                        for (var i = 0, l = node.edges.length; i < l; i++) {
                                            processNode(node.edges[i].target, lvl + 1);
                                        }
                                    }
                                }

                                for (var vp in me.potyvirusPorteinNames) {
                                    var n = graph.getVertexById(vp);
                                    if (n) {
                                        processNode(n, 1);

                                    }
                                }

                                if (layout == "force") {
                                    var r2 = new XMLHttpRequest();
                                    r2.open('GET', 'files/force-layout.txt', false);
                                    r2.send();
                                    var forceLayoutVertices = JSON.parse(r2.response);
                                    for (var i = 0; i < forceLayoutVertices.length; i++) {
                                        var v = forceLayoutVertices[i];
                                        var vertex = graph.getVertexById(v.id);
                                        var lvl = visited[vertex.id] || 15;
                                        var z = 1000 - (500 + lvl * 50);
                                        vertex.position.set(v.x, v.y, z);
                                    }

//                                    me.forceDirected(graph.vertices, graph.edges, function (d3Vertices) {
////                                    var ve = [];
//                                    for (var i = 0; i < d3Vertices.length; i++) {
//                                        var v = d3Vertices[i];
////                                        ve.push({x: v.x, y: v.y, id: v.id});
//                                        var vertex = graph.getVertexById(v.id);
//                                        var lvl = visited[vertex.id] || 15;
//                                        var z = 1000 - (500 + lvl * 50);
//                                        vertex.position.set(v.x, v.y, z);
//                                    }
////
////                                    var str = JSON.stringify(ve);
////                                    var blob = new Blob([str], {type: "data:text/tsv"});
////                                    var url = URL.createObjectURL(blob);
////                                    var link = document.createElement('a');
////                                    link.href = url;
////                                    link.download = "force-layout.txt";
////                                    var event = new MouseEvent('click', {
////                                        'view': window,
////                                        'bubbles': true,
////                                        'cancelable': true
////                                    });
////                                    link.dispatchEvent(event);
////                                });

                                    me.networkViewerWebgl.renderGraph(graph);
                                    var end = new Date().getTime();
                                    var time = end - start;
                                    me.showInfo("Done in " + (time) + " ms");
                                }

                                if (layout == "circle") {
                                    var levelMap = {};
                                    for (var i = 0, l = graph.vertices.length; i < l; i++) {
                                        var vertex = graph.vertices[i];
                                        var level = visited[vertex.id] || 15;
                                        if (levelMap[level] == null) {
                                            levelMap[level] = [];
                                        }
                                        levelMap[level].push(vertex);
                                    }
                                    for (level in levelMap) {
                                        var lvl = parseInt(level);
                                        me.circleLevels(levelMap[level], lvl * 50, (1000 - (500 + lvl * 50)))
                                    }
                                    me.networkViewerWebgl.renderGraph(graph);
                                    var end = new Date().getTime();
                                    var time = end - start;
                                    me.showInfo("Done in " + (time) + " ms");
                                }
                            },
                            'error:parse': function (event) {
                                console.log(event);
                            }
                        }
                    });

                };
                request.onerror = function () {
                    console.log('error loading file');
                };
                request.open('GET', 'files/Ath_Interactome.txt', true);
                request.send();
            },
            /* ** */
            /* ** */
            /* layout */
            /* ** */
            /* ** */
            circleLevels: function (vertices, radius, z) {
                var centerX = 0;
                var centerY = 0;
                var x, y;
                for (var i = 0, l = vertices.length; i < l; i++) {
                    var vertex = vertices[i];
                    if (typeof vertex !== 'undefined') {
                        x = centerX + radius * Math.sin(i * 2 * Math.PI / vertices.length);
                        y = centerY + radius * Math.cos(i * 2 * Math.PI / vertices.length);

                        vertex.position.set(x, y, z);
                    }
                }
            },

            sphereSurface: function (vertices, radius, offsetZ) {

                //        θ = theta
                //        φ = phi
                var n = vertices.length;

                for (var i = 0; i < vertices.length; i++) {
                    var vertex = vertices[i];
                    var phi = Math.acos(-1 + ( 2 * i ) / n);
                    var theta = Math.sqrt(n * Math.PI) * phi;
                    vertex.position.setX(radius * Math.cos(theta) * Math.sin(phi));
                    vertex.position.setY(radius * Math.sin(theta) * Math.sin(phi));
                    vertex.position.setZ(radius * Math.cos(phi) + offsetZ);
                }
            },


            forceDirected: function (vertices, edges, endFunction) {
                var force = d3.layout.force();

                force.charge(-50)
                force.linkDistance(40)

                /*------------------------------------------*/
                /*------------------------------------------*/
                console.time('Force directed preload');

                var d3Vertices = [];
                var d3VerticesMap = {};
                var d3Edges = [];

                //set node and edge arrays for D3
                for (var i = 0, l = vertices.length; i < l; i++) {
                    var vertex = vertices[i];
                    var v = {
                        id: vertex.id,
                        index: i
                    };
                    d3Vertices.push(v);
                    d3VerticesMap[vertex.id] = v;
                }
                force.nodes(d3Vertices);
                for (var i = 0, l = edges.length; i < l; i++) {
                    var edge = edges[i];
                    d3Edges.push({
                        source: d3VerticesMap[edge.source.id],
                        target: d3VerticesMap[edge.target.id]
                    });
                }
                force.links(d3Edges);


                force.on('end', function (o) {
                    console.log(o)
                    endFunction(d3Vertices);
                });

                console.time('D3 Force directed layout');
                force.start();
                var safety = 0;
                while (force.alpha() > 0.025) { // You'll want to try out different, "small" values for this
                    force.tick();
                    if (safety++ > 2000) {
                        break;// Avoids infinite looping in case this solution was a bad idea
                    }
                }
                console.log(safety);
                force.stop();
                console.timeEnd('D3 Force directed layout');


//    force.on('tick', function (o) {
//        endFunction(d3Vertices);
//        console.log(force.alpha())
//        if (force.alpha() < 0.025) {
//            force.stop()
//        }
//    });
//    force.start();

            }
        });
    </script>
</polymer-element>
