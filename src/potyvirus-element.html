<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer-fontawesome/polymer-fontawesome.html">
<link rel="import" href="../bower_components/sortable-table/sortable-table.html">
<script src="../lib/jsorolla/src/lib/opencga-manager.js"></script>
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-header.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-footer.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/jso-window.html">
<link rel="import" href="../lib/jsorolla/src/network-viewer/jso-network-viewer.html">
<link rel="import" href="potyvirus-home.html">
<link rel="import" href="potyvirus-menu.html">

<link rel="import" href="components/pty-toolbar.html">
<link rel="import" href="components/pty-header.html">
<link rel="import" href="components/pty-3d-toolbar.html">
<link rel="import" href="components/potyvirus-interactions-table.html">

<script src="../lib/jsorolla/src/network-viewer-webgl/network-viewer-webgl.js"></script>


<polymer-element name="potyvirus-element">
    <template>
        <link rel="stylesheet" href="../lib/jsorolla/src/lib/components/jso-style.css">
        <link rel="stylesheet" href="../lib/jsorolla/src/lib/components/jso-panel.css">
        <link rel="stylesheet" href="../lib/jsorolla/src/lib/components/jso-dropdown.css">
        <link rel="stylesheet" href="../lib/jsorolla/src/lib/components/jso-form.css">
        <style>
            :host {
                display: block;
                position: relative;
                /*background-color: #314559;*/

                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                cursor: default;

                font-size: 13px;
            }

            .content {
                background-color: #435f7a;
                position: relative;
                /*min-height: calc(100vh - 160px);*/
            }

            .content > * {
                min-height: calc(100vh - 110px);
            }

            /*potyvirus-interactions-table {*/
            /*height: calc(100vh - 60px);*/
            /*}*/
            jso-network-viewer, #nvwebgl {
                height: calc(100vh - 110px);
            }

            #stats {
                background-color: #FFFFFF;
                text-align: center;
                border-top: 1px solid #d3d3d3;
                padding-top: 20px;
            }

            .infoshown {
                visibility: visible !important;
                opacity: 1 !important;
            }

            #info {
                position: fixed;
                top: 70px;
                left: 153px;
                padding: 7px;
                background-color: #fff;
                box-shadow: 10px 10px 10px rgba(0, 0, 0, 0.2);
                /*transition: all 0.15s;*/
                visibility: hidden;
                opacity: 0;
                color: #666;
                min-height: inherit;
            }

            #menu3d {
                margin: 10px;
                position: fixed;
                top: 60px;
                left: 0px;
                min-height: inherit !important;
            }

            jso-footer {
                height: 50px;
            }

        </style>
        <jso-header selectedOption="{{selectedOption}}"
                    userData="{{userData}}"
                    showMenu="true"
                    allowLogin="false">
            <div class="title">Potyvirus</div>
            <potyvirus-menu class="menu" selectedOption="{{selectedOption}}">
            </potyvirus-menu>
        </jso-header>

        <div class="content">

            <template if="{{selectedOption == 'home' }}">
                <potyvirus-home></potyvirus-home>
            </template>

            <template if="{{selectedOption == 'stats' }}">
                <div id="stats">
                    <pty-heatmap></pty-heatmap>
                    <pty-simpson-index></pty-simpson-index>
                    <pty-4a></pty-4a>
                    <pty-4b></pty-4b>
                    <pty-4c></pty-4c>
                    <pty-4d></pty-4d>
                    <pty-4e></pty-4e>
                    <pty-4f></pty-4f>
                </div>
            </template>

            <potyvirus-interactions-table interactions="{{interactions}}" datasym="{{datasym}}" rcThreshold="{{rcThreshold}}"
                                          hidden?="{{selectedOption != 'interactions'}}"></potyvirus-interactions-table>
            <jso-network-viewer lite="false" id="networkViewer" hidden?="{{selectedOption != 'vhpi'}}"></jso-network-viewer>

            <div class="panel panel-shadow" id="menu3d" hidden?="{{selectedOption != 'vhpi3d'}}">
                <div class="header" horizontal layout>
                    <div class="text">Options</div>
                </div>
                <div class="container" style="padding:10px;">
                    <div class="button action" on-click="{{handle3dLayout}}" data-v="force">Force layout</div>
                    <div class="button action" on-click="{{handle3dLayout}}" data-v="circle">Circle</div>
                    <div style="margin-top: 20px;">
                        <div class="button action" on-click="{{handleProteinMenu}}" data-protein="all">All</div>
                        <template repeat="{{b in  potyvirusPorteinNameList}}">
                            <div class="button action" on-click="{{handleProteinMenu}}" data-checked="{{currentProtein == b}}" data-protein="{{b}}">{{b}}</div>
                        </template>
                    </div>
                </div>
            </div>
            <div id="nvwebgl" hidden?="{{selectedOption != 'vhpi3d'}}">
            </div>

            <div id="info" hidden?="{{selectedOption != 'vhpi3d'}}">{{message}}</div>
        </div>
        <jso-footer>
            Potyvirus -
            Universitat Politècnica de Valencia, Valencia, Spain -
            Principe Felipe Research Center, Valencia, Spain -
            2015
        </jso-footer>
    </template>
    <script>
        Polymer({
            created: function () {
                this.interactions = [];
                this.datasym = [];
                this.userData;
                this.potyvirusPorteinNames = {
//                    'P1': true,
//                    'HC-Pro': true,
//                    'P3': true,
//                    '6K1': true,
//                    'CI': true,
//                    '6K2': true,
//                    'VPg': true,
//                    'NIa-Pro': true,
//                    'NIb': true,
//                    'CP': true,
//                    'P3N-PIPO': true
                };
                this.potyvirusPorteinNameList = [];

                this.message = "";

                this.rcThreshold = 44;

                this.layout = 'force'
                this.currentProtein = 'all'
            },
            selectedOptionChanged: function () {
                var me = this;
                setTimeout(function () {
//                    me.$.networkViewer.zoom = 20;
                    me.$.networkViewer.setLayout('Circle');
                }, 300);
            },
            handle3dLayout: function (e) {
                this.showInfo("Loading...");
                this.layout = e.currentTarget.dataset.v;
                this.testPlantInteractome(this.layout, this.currentProtein);
            },
            handleProteinMenu: function (e) {
                this.showInfo("Loading...");
                this.currentProtein = e.currentTarget.dataset.protein;
                this.testPlantInteractome(this.layout, this.currentProtein);
            },
            showInfo: function (msg) {
                if (msg == false) {
                    this.message = "";
                    this.$.info.classList.remove('infoshown');
                } else {
                    this.message = msg;
                    this.$.info.classList.add('infoshown');
                }
            },
            ready: function () {
                this.selectedOption = 'vhpi3d';
                this.$.networkViewer.selectedMenu = '';
                this.$.networkViewer.hideNodeSimpleRendering = true;
                this.$.networkViewer.hideEdgeSimpleRendering = true;
            },
            domReady: function () {
//                this.getInteractionsSif();

                this.getInteractions();

                var height = window.innerHeight - 65;
                var width = window.innerWidth;
                this.networkViewerWebgl = new NetworkViewerWebgl({
                    target: this.$.nvwebgl,
                    width: width,
                    height: height
                });

                var me = this;
                setTimeout(function () {
//                    me.getPlantInteractome();
                    me.testPlantInteractome("force");
                }, 100);
            },
            rcThresholdChanged: function () {
                this.updateNetworkViewerGraph();
            },
            getInteractions: function () {
                var me = this;

                var undirectedMap = {};
                var interactions = [];
                var responseCount = 0;

                var request = new XMLHttpRequest();
                request.onload = function () {
                    var response = this.response;

                    responseCount++;
                    var lines = response.split('\n');
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.trim().length != 0) {
                            var fields = line.split('\t');
                            var key1 = fields[0] + fields[1] + fields[3];
                            var key2 = fields[1] + fields[0] + fields[3];
                            if (undirectedMap[key1] != true && undirectedMap[key2] != true) {
                                var obj = {
                                    p1: fields[0],
                                    p2: fields[1],
                                    reference: fields[2],
                                    species: fields[3],
                                    detection: fields[4],
                                    intesity: fields[5],
                                    detected: fields[6],
                                    tested: fields[7]
                                };
//                                if (obj.p1 == 'P1' && obj.p2 == 'HCPro') {
                                interactions.push(obj);
                                undirectedMap[key1] = true;
                                undirectedMap[key2] = true;
//                                }

                            }

                        }
                    }
                    me.interactions = interactions;
                    me.processDataSym();

                };
                request.onerror = function () {
                    console.log('error loading file');
                };
                request.open('GET', 'files/interactions.tsv', true);
                request.send();
            },
            processDataSym: function () {
//                                              BiFC	            Y2H		            Total
//                Protein A	Protein B	Detected	Tested	Detected	Tested	Detected	Tested	RC
                var map = {};
                var datasym = [];
                for (var i = 0; i < this.interactions.length; i++) {
                    var interaction = this.interactions[i];
                    var key1 = interaction.p1 + ">" + interaction.p2;
                    var key2 = interaction.p2 + "<" + interaction.p1;
                    if (map[key1] == null && map[key2] == null) {
                        var obj = {
                            p1: interaction.p1,
                            p2: interaction.p2,
                            detectedbifc: 0,
                            testedbifc: 0,
                            detectedy2h: 0,
                            testedy2h: 0,
                            detectedtotal: 0,
                            testedtotal: 0,
                            rc: 0
                        }
                        map[key1] = obj;
                        map[key2] = true;
                        datasym.push(obj);
                    }
                    var obj = map[key1];
                    var d = (parseInt(interaction.detected) > 0) ? 1 : 0;
                    var t = (parseInt(interaction.tested) > 0) ? 1 : 0;
                    if (interaction.detection == 'BiFC') {
                        obj.detectedbifc += d;
                        obj.testedbifc += t;
                    } else if (interaction.detection == 'Y2H') {
                        obj.detectedy2h += d;
                        obj.testedy2h += t;
                    }
                    obj.detectedtotal += d;
                    obj.testedtotal += t;


                }
                for (var i = 0; i < datasym.length; i++) {
                    var symi = datasym[i];
                    symi.rc = ((2 / (symi.testedtotal + 1)) * symi.detectedbifc) + ((1 / (symi.testedtotal + 1)) * symi.detectedy2h);
                    symi.rc = Math.round(symi.rc * 100);
                }

                this.datasym = datasym;

                this.updateNetworkViewerGraph();
            },
            updateNetworkViewerGraph: function () {
                this.$.networkViewer.startOver();
                for (var i = 0; i < this.datasym.length; i++) {
                    var obj = this.datasym[i];
                    if (obj.rc >= this.rcThreshold) {
                        var sourceVertex = this.$.networkViewer.createVertex(0, 0, obj.p1);
                        var targetVertex = this.$.networkViewer.createVertex(0, 0, obj.p2);

                        this.$.networkViewer.createEdge(sourceVertex, targetVertex, 'link');
                    }
                }
                this.potyvirusPorteinNameList = [];
                this.potyvirusPorteinNames = {};
                for (var i = 0; i < this.$.networkViewer.graph.vertices.length; i++) {
                    var vertex = this.$.networkViewer.graph.vertices[i];
                    this.potyvirusPorteinNameList.push(vertex.id);
                    this.potyvirusPorteinNames[vertex.id] = true;
                }
            },

            handleAppMenu: function (e) {
                this.$.sidePanel.classList.toggle('side-panel-shown');
            },
            getPlantInteractome: function () {
                var me = this;
                var request = new XMLHttpRequest();
                request.onload = function () {
                    var textNetworkDataAdapter = new TextNetworkDataAdapter({
                        dataSource: new StringDataSource(this.response),
                        handlers: {
                            'data:load': function (event) {
//                        var graph = event.sender.parseColumns(0, 1, -1, 'hh');
                                var graph = event.sender.parseColumns(0, 2, 1);

//                        sphereSurface(graph.vertices, 400, 300);
//                        circleLevels(graph.vertices, 600, 300);


//                        var virusVertices = [];
//                        var plantVertices = [];
//
//                        for (var i = 0, l = graph.vertices.length; i < l; i++) {
//                            var vertex = graph.vertices[i];
//                            if (typeof vertex !== 'undefined') {
//                                if (vertex.id in potyvirusPorteinNames) {
//                                    virusVertices.push(vertex);
//                                } else {
//                                    plantVertices.push(vertex);
//                                }
//                            }
//                        }
//                            circleLevels(virusVertices, 300, 50);
//                            circleLevels(plantVertices, 500, 350);
//                            networkViewerWebgl.renderGraph(graph);

                                me.forceDirected(graph.vertices, graph.edges, function (vertices) {
                                    for (var i = 0; i < vertices.length; i++) {
                                        var v = vertices[i];
                                        var vertex = graph.getVertexById(v.id);
                                        var z = 0;
                                        if (vertex.id in me.potyvirusPorteinNames) {
                                            z = 100;
                                        } else {
                                            z = 300;
                                        }
                                        vertex.position.set(v.x, v.y, z);
                                    }
                                    me.networkViewerWebgl.renderGraph(graph);
                                });

                            },
                            'error:parse': function (event) {
                                console.log(event);
                            }
                        }
                    });

                };
                request.onerror = function () {
                    console.log('error loading file');
                };
                request.open('GET', 'files/vh0-1.sif', true);
                request.send();
            },
            testPlantInteractome: function (layout, protein) {
                this.showInfo("Loading...");
                var start = new Date().getTime();

                var me = this;
                var request = new XMLHttpRequest();
                request.onload = function () {
                    var textNetworkDataAdapter = new TextNetworkDataAdapter({
                        dataSource: new StringDataSource(this.response),
                        handlers: {
                            'data:load': function (event) {
                                var graph = event.sender.parseColumns(0, 1, -1, 'link');

                                var virusVertices = [];

                                var visited = {};
                                var processNode = function (node, lvl) {
                                    if (!visited[node.id]) {
                                        visited[node.id] = lvl;
                                        for (var i = 0, l = node.edges.length; i < l; i++) {
                                            processNode(node.edges[i].target, lvl + 1);
                                        }
                                    }
                                }

                                if (protein === 'all' || protein == null) {
                                    var virusGraph = me.$.networkViewer.graph;
                                    for (var i = 0; i < virusGraph.vertices.length; i++) {
                                        var virusVertex = virusGraph.vertices[i];
                                        var v = new Vertex({id: virusVertex.id});
                                        graph.addVertex(v);
                                        virusVertices.push(v);
                                    }
                                    for (var i = 0; i < virusGraph.edges.length; i++) {
                                        var virusEdge = virusGraph.edges[i];
                                        var sv = graph.getVertexById(virusEdge.source.id);
                                        var tv = graph.getVertexById(virusEdge.target.id);
                                        var edgeId = sv.id + '_' + 'link' + '_' + tv.id;
                                        graph.addEdge(new Edge({
                                            id: edgeId,
                                            relation: 'link',
                                            source: sv,
                                            target: tv
                                        }));
                                    }

                                    for (var vp in me.potyvirusPorteinNames) {
                                        var n = graph.getVertexById(vp);
                                        if (n) {
                                            processNode(n, 1);
                                        }
                                    }
                                } else {
                                    graph.addVertex(new Vertex({id: protein}));
                                    var n = graph.getVertexById(protein);
                                    virusVertices.push(n);
                                    if (n) {
                                        processNode(n, 1);
                                    }
                                }

                                if (layout == "force") {
                                    var r2 = new XMLHttpRequest();
                                    r2.open('GET', 'files/force-layout.txt', false);
                                    r2.send();
                                    var forceLayoutVertices = JSON.parse(r2.response);
                                    for (var i = 0; i < forceLayoutVertices.length; i++) {
                                        var v = forceLayoutVertices[i];
                                        var vertex = graph.getVertexById(v.id);
                                        if (vertex) {
                                            var lvl = visited[vertex.id] || 15;
                                            var z = 1000 - (500 + lvl * 50);
                                            vertex.position.set(v.x, v.y, z);

                                            if (vertex.id in me.potyvirusPorteinNames) {
                                                vertex.renderer.size = 80;
                                            }
                                        }
                                    }

//                                    me.forceDirected(graph.vertices, graph.edges, function (d3Vertices) {
//                                    var ve = [];
//                                        for (var i = 0; i < d3Vertices.length; i++) {
//                                            var v = d3Vertices[i];
//                                        ve.push({x: v.x, y: v.y, id: v.id});
//                                            var vertex = graph.getVertexById(v.id);
//                                            var lvl = visited[vertex.id] || 15;
//                                            var z = 1000 - (500 + lvl * 50);
//                                            vertex.position.set(v.x, v.y, z);
//                                        }
////
//                                        var str = JSON.stringify(ve);
//                                        var blob = new Blob([str], {type: "data:text/tsv"});
//                                        var url = URL.createObjectURL(blob);
//                                        var link = document.createElement('a');
//                                        link.href = url;
//                                        link.download = "force-layout.txt";
//                                        var event = new MouseEvent('click', {
//                                            'view': window,
//                                            'bubbles': true,
//                                            'cancelable': true
//                                        });
//                                        link.dispatchEvent(event);
//                                    });

                                    me.circleLevels(virusVertices, 200, 600);
                                    for (var i = 0; i < virusVertices.length; i++) {
                                        var v = virusVertices[i];
                                        var vertex = graph.getVertexById(v.id);
                                        vertex.position.set(v.position.x, v.position.y, v.position.z);
                                    }

                                    me.networkViewerWebgl.renderGraph(graph);
                                    var end = new Date().getTime();
                                    var time = end - start;
                                    me.showInfo("Done in " + (time) + " ms");
                                }

                                if (layout == "circle") {
                                    var levelMap = {};
                                    for (var i = 0, l = graph.vertices.length; i < l; i++) {
                                        var vertex = graph.vertices[i];
                                        var level = visited[vertex.id] || 15;
                                        if (levelMap[level] == null) {
                                            levelMap[level] = [];
                                        }
                                        levelMap[level].push(vertex);

                                        if (vertex.id in me.potyvirusPorteinNames) {
                                            vertex.renderer.size = vertex.renderer.size * 3
                                        }
                                    }
                                    for (level in levelMap) {
                                        var lvl = parseInt(level);
                                        me.circleLevels(levelMap[level], lvl * 80, (1000 - (500 + lvl * 50)))
                                    }

                                    me.circleLevels(virusVertices, 200, 600);
                                    for (var i = 0; i < virusVertices.length; i++) {
                                        var v = virusVertices[i];
                                        var vertex = graph.getVertexById(v.id);
                                        vertex.position.set(v.position.x, v.position.y, v.position.z);
                                    }

                                    me.networkViewerWebgl.renderGraph(graph);
                                    var end = new Date().getTime();
                                    var time = end - start;
                                    me.showInfo("Done in " + (time) + " ms");
                                }


                            },
                            'error:parse': function (event) {
                                console.log(event);
                            }
                        }
                    });

                };
                request.onerror = function () {
                    console.log('error loading file');
                };
                request.open('GET', 'files/Ath_Interactome.txt', true);
                request.send();
            },
            /* ** */
            /* ** */
            /* layout */
            /* ** */
            /* ** */
            circleLevels: function (vertices, radius, z) {
                var centerX = 0;
                var centerY = 0;
                var x, y;
                for (var i = 0, l = vertices.length; i < l; i++) {
                    var vertex = vertices[i];
                    if (typeof vertex !== 'undefined') {
                        x = centerX + radius * Math.sin(i * 2 * Math.PI / vertices.length);
                        y = centerY + radius * Math.cos(i * 2 * Math.PI / vertices.length);

                        vertex.position.set(x, y, z);
                    }
                }
            },

            sphereSurface: function (vertices, radius, offsetZ) {

                //        θ = theta
                //        φ = phi
                var n = vertices.length;

                for (var i = 0; i < vertices.length; i++) {
                    var vertex = vertices[i];
                    var phi = Math.acos(-1 + ( 2 * i ) / n);
                    var theta = Math.sqrt(n * Math.PI) * phi;
                    vertex.position.setX(radius * Math.cos(theta) * Math.sin(phi));
                    vertex.position.setY(radius * Math.sin(theta) * Math.sin(phi));
                    vertex.position.setZ(radius * Math.cos(phi) + offsetZ);
                }
            },


            forceDirected: function (vertices, edges, endFunction) {
                var force = d3.layout.force();

                force.charge(-50)
                force.linkDistance(40)

                /*------------------------------------------*/
                /*------------------------------------------*/
                console.time('Force directed preload');

                var d3Vertices = [];
                var d3VerticesMap = {};
                var d3Edges = [];

                //set node and edge arrays for D3
                for (var i = 0, l = vertices.length; i < l; i++) {
                    var vertex = vertices[i];
                    var v = {
                        id: vertex.id,
                        index: i
                    };
                    d3Vertices.push(v);
                    d3VerticesMap[vertex.id] = v;
                }
                force.nodes(d3Vertices);
                for (var i = 0, l = edges.length; i < l; i++) {
                    var edge = edges[i];
                    d3Edges.push({
                        source: d3VerticesMap[edge.source.id],
                        target: d3VerticesMap[edge.target.id]
                    });
                }
                force.links(d3Edges);


                force.on('end', function (o) {
                    console.log(o)
                    endFunction(d3Vertices);
                });

                console.time('D3 Force directed layout');
                force.start();
                var safety = 0;
                while (force.alpha() > 0.025) { // You'll want to try out different, "small" values for this
                    force.tick();
                    if (safety++ > 2000) {
                        break;// Avoids infinite looping in case this solution was a bad idea
                    }
                }
                console.log(safety);
                force.stop();
                console.timeEnd('D3 Force directed layout');


//    force.on('tick', function (o) {
//        endFunction(d3Vertices);
//        console.log(force.alpha())
//        if (force.alpha() < 0.025) {
//            force.stop()
//        }
//    });
//    force.start();

            }
        });
    </script>
</polymer-element>
